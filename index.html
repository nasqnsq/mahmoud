<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø´Ø®ØµÙŠØ©</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #16a34a;
        }

        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ© */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .balance-usd { font-size: 1.5em; font-weight: bold; color: var(--primary); }
        .balance-try { font-size: 1.5em; font-weight: bold; color: var(--text); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #9ca3af; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .tx-list { list-style: none; padding: 0; }
        .tx-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .tx-amount.income { color: var(--success); }
        .tx-amount.expense { color: var(--danger); }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #status-msg { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; background: #333; color: white; display: none; z-index: 1000; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯</h2>
        <div>
            <button id="authBtn" onclick="handleAuthClick()">Ø±Ø¨Ø· Google Drive</button>
            <button id="syncBtn" class="secondary" onclick="syncData()" style="display: none;">Ù…Ø²Ø§Ù…Ù†Ø© ğŸ”„</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div>Ø§Ù„ØµØ§ÙÙŠ (Ø¯ÙˆÙ„Ø§Ø±)</div>
            <div class="balance-usd" id="net-usd">0 $</div>
        </div>
        <div class="card">
            <div>Ø§Ù„ØµØ§ÙÙŠ (Ù„ÙŠØ±Ø©)</div>
            <div class="balance-try" id="net-try">0 â‚º</div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ (Ù…Ø«Ø§Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ³ÙˆÙ‚)">
            <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="currency">
                <option value="USD">Ø¯ÙˆÙ„Ø§Ø± ($)</option>
                <option value="TRY">Ù„ÙŠØ±Ø© (â‚º)</option>
            </select>
            <select id="type">
                <option value="expense">Ù…ØµØ±ÙˆÙ (Ø®Ø±Ø¬)</option>
                <option value="income">Ø¥ÙŠØ±Ø§Ø¯ (Ø¯Ø®Ù„)</option>
            </select>
        </div>
        <button onclick="addTransaction()" style="width: 100%">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div class="card">
        <h3>Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
        <ul id="tx-list" class="tx-list"></ul>
    </div>
</div>

<div id="status-msg"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
    // ØªÙ… Ø¥Ø¶Ø§ÙØ© Client ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
    const CLIENT_ID = '936346921354-koe7pedt9pdiocbrhbe0id9jjc89ctpo.apps.googleusercontent.com'; 
    
    // âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ Ù„ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯
    const API_KEY = 'YOUR_API_KEY_HERE'; 

    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FILE_NAME = 'mahmoud_data_final.json';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ---
    let appData = JSON.parse(localStorage.getItem('mahmoudData')) || { transactions: [] };

    function saveDataLocally() {
        localStorage.setItem('mahmoudData', JSON.stringify(appData));
        renderUI();
    }

    function addTransaction() {
        const desc = document.getElementById('desc').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const currency = document.getElementById('currency').value;
        const type = document.getElementById('type').value;

        if (!desc || isNaN(amount)) {
            showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', true);
            return;
        }

        appData.transactions.unshift({
            id: Date.now(),
            date: new Date().toISOString(),
            desc, amount, currency, type
        });

        saveDataLocally();
        
        // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
        showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹');
    }

    function renderUI() {
        const list = document.getElementById('tx-list');
        list.innerHTML = '';
        
        let usd = 0, try_val = 0;

        appData.transactions.forEach(tx => {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            if (tx.currency === 'USD') {
                usd += tx.type === 'income' ? tx.amount : -tx.amount;
            } else {
                try_val += tx.type === 'income' ? tx.amount : -tx.amount;
            }

            // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±
            const li = document.createElement('li');
            li.className = 'tx-item';
            li.innerHTML = `
                <div>
                    <strong>${tx.desc}</strong><br>
                    <small style="color:#666">${new Date(tx.date).toLocaleDateString('ar-EG')}</small>
                </div>
                <div class="tx-amount ${tx.type}">
                    ${tx.type === 'income' ? '+' : '-'}${tx.amount} ${tx.currency}
                </div>
            `;
            list.appendChild(li);
        });

        document.getElementById('net-usd').innerText = `${usd.toFixed(2)} $`;
        document.getElementById('net-try').innerText = `${try_val.toFixed(2)} â‚º`;
    }

    // --- Ù…Ù†Ø·Ù‚ Google Drive ---

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
    window.onload = function() {
        gapi.load('client', initializeGapiClient);
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        });
        gisInited = true;
        renderUI(); // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    };

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        checkAuthStatus();
    }

    function checkAuthStatus() {
        if (gapiInited && gisInited) {
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¬Ø§Ù‡Ø²
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            document.getElementById('authBtn').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'inline-block';
            await loadFromDrive(); // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ± Ø§Ù„Ø§ØªØµØ§Ù„
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    async function syncData() {
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...', false, true);
        try {
            const fileId = await findFileId();

            if (fileId) {
                // ØªØ­Ø¯ÙŠØ« (PATCH)
                await updateFileContent(fileId, appData);
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø§ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ (POST)
                await createFile(appData);
                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø§ÙŠÙ');
            }
        } catch (err) {
            console.error(err);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + (err.message || 'Unknown'), true);
        } finally {
            showToast('Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', false, false);
        }
    }

    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
    async function findFileId() {
        try {
            const response = await gapi.client.drive.files.list({
                'q': `name = '${FILE_NAME}' and trashed = false`,
                'fields': 'files(id, name)',
                'spaces': 'drive'
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                return files[0].id;
            }
            return null;
        } catch (err) {
            throw new Error("ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª - ØªØ£ÙƒØ¯ Ù…Ù† API Key");
        }
    }

    // 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadFromDrive() {
        try {
            const fileId = await findFileId();
            if (!fileId) return;

            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });

            if (response.result && typeof response.result === 'object') {
                appData = response.result;
                if (!appData.transactions) appData.transactions = [];
                saveDataLocally();
                showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
            }
        } catch (err) {
            showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
        }
    }

    // 5. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ (POST)
    async function createFile(data) {
        const fileContent = JSON.stringify(data);
        const metadata = {
            'name': FILE_NAME,
            'mimeType': 'application/json'
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([fileContent], { type: 'application/json' }));

        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
            body: form
        });
    }

    // 6. ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù (PATCH)
    async function updateFileContent(fileId, data) {
        const fileContent = JSON.stringify(data);
        const metadata = { 'mimeType': 'application/json' };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([fileContent], { type: 'application/json' }));

        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
            method: 'PATCH',
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
            body: form
        });
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function showToast(msg, isError = false, isLoading = false) {
        const el = document.getElementById('status-msg');
        el.innerText = msg;
        el.style.display = 'block';
        el.style.background = isError ? '#dc2626' : '#333';
        
        if (isLoading) document.body.classList.add('loading');
        else document.body.classList.remove('loading');

        if (!isLoading) {
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }
    }
</script>

</body>
</html>
