<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯</title>
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --bg: #f4f6f9;
            --white: #ffffff;
            --text: #333;
            --danger: #dc3545;
            --success: #28a745;
            --gray: #6c757d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); }

        /* Login Screen */
        #login-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        .login-box { width: 85%; max-width: 350px; text-align: center; }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 15px; background: var(--white); color: var(--primary); 
            border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px;
        }

        /* App Screen */
        #app-screen { display: none; padding: 15px; padding-bottom: 80px; }
        
        /* Header & Balance */
        .header { margin-bottom: 20px; text-align: center; }
        .balance-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .balance-card {
            flex: 1; background: var(--white); padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center;
        }
        .balance-title { font-size: 12px; color: var(--gray); margin-bottom: 5px; }
        .balance-amount { font-size: 20px; font-weight: bold; direction: ltr; }
        .usd { color: var(--success); }
        .try { color: var(--primary); }

        /* Form */
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
            background: #fff;
        }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sync { background: var(--gray); color: white; margin-bottom: 15px; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* List */
        .transaction-list { list-style: none; padding: 0; margin: 0; }
        .transaction-item {
            background: var(--white); border-radius: 10px; padding: 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-right: 4px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .border-in { border-right-color: var(--success); }
        .border-out { border-right-color: var(--danger); }
        
        .t-info h4 { margin: 0 0 5px 0; font-size: 16px; }
        .t-meta { font-size: 12px; color: var(--gray); }
        .t-amount { font-weight: bold; font-size: 16px; direction: ltr; text-align: left; }
        .t-actions { display: flex; gap: 10px; margin-top: 5px; }
        .action-btn { background: none; border: none; font-size: 18px; padding: 5px; cursor: pointer; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toast */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px;
            transform: translateX(-50%);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯</h2>
            <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <p id="login-msg" style="color: #ffcccc; font-size: 14px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-screen">
        <div class="balance-container">
            <div class="balance-card">
                <div class="balance-title">Ø§Ù„Ø±ØµÙŠØ¯ (USD)</div>
                <div class="balance-amount usd" id="bal-usd">0.00 $</div>
            </div>
            <div class="balance-card">
                <div class="balance-title">Ø§Ù„Ø±ØµÙŠØ¯ (TRY)</div>
                <div class="balance-amount try" id="bal-try">0.00 â‚º</div>
            </div>
        </div>

        <button class="btn btn-sync" onclick="syncData()">
            <span id="sync-text">Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ© (GitHub)</span>
            <div class="loader" id="sync-loader"></div>
        </button>

        <div class="card">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ (Ù…Ø«Ø§Ù„: Ø±Ø§ØªØ¨ØŒ Ù…Ø´ØªØ±ÙŠØ§Øª..)">
            </div>
            <div class="row form-group">
                <div class="col">
                    <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01">
                </div>
                <div class="col">
                    <select id="currency">
                        <option value="USD">Ø¯ÙˆÙ„Ø§Ø± ($)</option>
                        <option value="TRY">Ù„ÙŠØ±Ø© (â‚º)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <select id="type">
                    <option value="in">Ø¯Ø®Ù„ (+)</option>
                    <option value="out">Ø®Ø±Ø¬ (-)</option>
                </select>
            </div>
            <button class="btn btn-primary" id="save-btn" onclick="saveTransaction()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
            <button class="btn btn-danger" id="cancel-edit" onclick="resetForm()" style="display:none; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div id="transactions-container">
            <ul class="transaction-list" id="list">
                </ul>
        </div>
    </div>

    <div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>

    <script>
        // === Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===
        let GH_CONFIG = {}; // Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        let transactions = [];
        let fileSha = null; // Ù„Ø­ÙØ¸ SHA Ø§Ù„Ù…Ù„Ù Ù…Ù† GitHub

        // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ===
        function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');

            if (u === 'mahmoud' && p === '1234shb') {
                // Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                GH_CONFIG = {
                    token: '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',
                    owner: 'nasqnsq',
                    repo: 'shop',
                    path: 'data.json'
                };
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                
                loadFromLocal(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
                updateUI();
            } else {
                msg.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            }
        }

        // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ===
        function loadFromLocal() {
            const data = localStorage.getItem('mahmoud_accounting_data');
            if (data) {
                transactions = JSON.parse(data);
            }
        }

        function saveToLocal() {
            localStorage.setItem('mahmoud_accounting_data', JSON.stringify(transactions));
            updateUI();
        }

        // === Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
        function updateUI() {
            const list = document.getElementById('list');
            const balUsd = document.getElementById('bal-usd');
            const balTry = document.getElementById('bal-try');
            
            list.innerHTML = '';
            
            let totalUsd = 0;
            let totalTry = 0;

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            const sortedTrans = [...transactions].reverse();

            sortedTrans.forEach(t => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
                const val = parseFloat(t.amount);
                if (t.currency === 'USD') {
                    totalUsd += (t.type === 'in' ? val : -val);
                } else {
                    totalTry += (t.type === 'in' ? val : -val);
                }

                // Ø¨Ù†Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const li = document.createElement('li');
                li.className = `transaction-item ${t.type === 'in' ? 'border-in' : 'border-out'}`;
                li.innerHTML = `
                    <div class="t-info">
                        <h4>${t.desc}</h4>
                        <div class="t-meta">${t.date} | ${t.type === 'in' ? 'Ø¯Ø®Ù„' : 'Ø®Ø±Ø¬'}</div>
                    </div>
                    <div style="text-align: left;">
                        <div class="t-amount" style="color: ${t.type === 'in' ? 'var(--success)' : 'var(--danger)'}">
                            ${t.type === 'in' ? '+' : '-'}${val.toLocaleString()} ${t.currency === 'USD' ? '$' : 'â‚º'}
                        </div>
                        <div class="t-actions">
                            <button class="action-btn" onclick="editTransaction(${t.id})">âœï¸</button>
                            <button class="action-btn" onclick="deleteTransaction(${t.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
            balUsd.textContent = `${totalUsd.toLocaleString(undefined, {minimumFractionDigits: 2})} $`;
            balTry.textContent = `${totalTry.toLocaleString(undefined, {minimumFractionDigits: 2})} â‚º`;
        }

        // === Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù ===
        function saveTransaction() {
            const desc = document.getElementById('desc').value;
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const type = document.getElementById('type').value;
            const editId = document.getElementById('edit-id').value;

            if (!desc || !amount) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                return;
            }

            if (editId) {
                // ØªØ¹Ø¯ÙŠÙ„
                const index = transactions.findIndex(t => t.id == editId);
                if (index > -1) {
                    transactions[index] = {
                        ...transactions[index],
                        desc, amount, currency, type
                    };
                }
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
                const newTrans = {
                    id: Date.now(),
                    desc,
                    amount,
                    currency,
                    type,
                    date: new Date().toLocaleDateString('ar-EG')
                };
                transactions.push(newTrans);
            }

            saveToLocal();
            resetForm();
            showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹");
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id == id);
            if (t) {
                document.getElementById('desc').value = t.desc;
                document.getElementById('amount').value = t.amount;
                document.getElementById('currency').value = t.currency;
                document.getElementById('type').value = t.type;
                document.getElementById('edit-id').value = t.id;
                
                document.getElementById('save-btn').textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
                document.getElementById('cancel-edit').style.display = "block";
                window.scrollTo(0,0);
            }
        }

        function deleteTransaction(id) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
                transactions = transactions.filter(t => t.id != id);
                saveToLocal();
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            }
        }

        function resetForm() {
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('save-btn').textContent = "Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©";
            document.getElementById('cancel-edit').style.display = "none";
        }

        // === GitHub Sync (Ø§Ù„Ø°ÙƒØ§Ø¡ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚) ===
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù€ Base64 Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        function utf8_to_b64(str) {
            return window.btoa(unescape(encodeURIComponent(str)));
        }

        function b64_to_utf8(str) {
            return decodeURIComponent(escape(window.atob(str)));
        }

        async function syncData() {
            const btn = document.getElementById('sync-text');
            const loader = document.getElementById('sync-loader');
            
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...";
            loader.style.display = "inline-block";

            const apiUrl = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`;
            const headers = {
                'Authorization': `token ${GH_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json'
            };

            try {
                // 1. Ø§Ù„Ø¬Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹ (GET)
                const response = await fetch(apiUrl, { headers: headers, cache: "no-store" });
                
                if (response.status === 200) {
                    const data = await response.json();
                    fileSha = data.sha; // Ø­ÙØ¸ Ø§Ù„Ù€ SHA Ù„Ù„ØªØ­Ø¯ÙŠØ«
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    // Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ø§Ù„Ø®Ø§Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©ØŒ Ù„ÙƒÙ† Ù„Ù† Ù†Ø®Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ù„ÙŠ
                    // Ù„Ù„ØªØ¨Ø³ÙŠØ· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø®ØµÙŠ: Ø³Ù†Ø¹ØªÙ…Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆÙ†Ø±ÙØ¹Ù‡ØŒ 
                    // ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¯Ù…Ø¬ Ù…Ø¹Ù‚Ø¯ ÙŠÙ…ÙƒÙ† ÙØ¹Ù„Ù‡ Ù‡Ù†Ø§.
                    // Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù€ SHAØŒ 
                    // ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡Ø§.
                    
                    // ÙÙŠ Ø­Ø§Ù„Ø© "Ù…Ø­Ù…ÙˆØ¯"ØŒ Ù‡Ùˆ ÙŠØ±ÙŠØ¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©. Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† LocalStorage Ù‡Ùˆ Ø§Ù„Ø£Ø­Ø¯Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø£Ù†Ù‡ ÙŠØ¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡.
                    // Ù„ÙƒÙ† "Ø§Ù„Ø¬Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹" Ø·Ù„Ø¨Ù‡ Ù„Ù„Ø­Ù…Ø§ÙŠØ©. Ù„Ø°Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ§Ù„ÙŠ:
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙØ§Ø±ØºØ©ØŒ Ù†Ù…Ù„Ø£Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù…ØªÙ„Ø¦Ø©ØŒ Ù†Ø¹ØªÙ…Ø¯Ù‡Ø§ Ù‡ÙŠ ÙˆÙ†Ø±ÙØ¹Ù‡Ø§ (Ù„Ø£Ù†Ù†Ø§ Ø¹Ø¯Ù„Ù†Ø§ Ø¹Ù„ÙŠÙ‡Ø§).
                    
                    const serverContent = JSON.parse(b64_to_utf8(data.content));
                    
                    if (transactions.length === 0 && serverContent.length > 0) {
                        transactions = serverContent;
                        saveToLocal();
                        showToast("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
                    }
                } else if (response.status === 404) {
                    console.log("File not created yet, creating new.");
                    fileSha = null; // Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                }

                // 2. Ø§Ù„Ø±ÙØ¹ (PUT)
                btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
                
                const contentEncoded = utf8_to_b6
