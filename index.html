<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --primary: #4f46e5;
            --green: #10b981; --red: #ef4444; --orange: #f59e0b;
            --text-main: #1e293b; --text-sub: #64748b;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 12px; color: var(--text-main); line-height: 1.6; }
        .container { max-width: 500px; margin: 0 auto; }
        header { text-align: center; padding: 10px 0 20px 0; }
        header h2 { margin: 0; color: var(--primary); font-size: 1.6rem; font-weight: 800; }

        /* Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; border: 1px solid #e2e8f0; }
        .full-width { grid-column: span 2; border-bottom: 4px solid var(--primary); }
        .stat-label { display: block; font-size: 0.85rem; color: var(--text-sub); font-weight: 600; }
        .stat-val { display: block; font-weight: 800; font-size: 1.3rem; margin-top: 5px; }
        .val-total { color: var(--primary); } .val-in { color: var(--green); } .val-out { color: var(--red); }

        /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - Ù…Ø®ØµØµ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .entry-card { background: var(--card); padding: 20px; border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 12px; }
        input, select { flex: 1; padding: 14px; border: 1px solid #cbd5e1; border-radius: 14px; font-family: 'Cairo'; font-size: 1rem; outline: none; background: #fff; transition: all 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        #addBtn { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        #addBtn:active { transform: scale(0.97); }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        .list-header { font-weight: 700; margin-bottom: 10px; padding: 0 5px; display: flex; justify-content: space-between; }
        .tx-list { background: var(--card); border-radius: 22px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .tx-item:last-child { border-bottom: none; }
        .tx-info b { display: block; font-size: 1rem; color: var(--text-main); }
        .tx-info small { color: var(--text-sub); font-size: 0.8rem; }
        .tx-amount-box { text-align: left; }
        .tx-amount { font-weight: 800; font-size: 1.1rem; display: block; }
        .del-btn { color: #94a3b8; border: none; background: none; padding: 5px; cursor: pointer; font-size: 1.2rem; margin-right: 10px; }
        .del-btn:hover { color: var(--red); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª */
        .footer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; padding-bottom: 30px; }
        .btn-footer { background: white; border: 1px solid #e2e8f0; padding: 14px; border-radius: 15px; font-weight: 700; cursor: pointer; font-family: 'Cairo'; font-size: 0.9rem; transition: 0.2s; }
        .btn-drive { grid-column: span 2; background: #4285F4; color: white; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #syncStatus { text-align: center; font-size: 0.8rem; color: var(--text-sub); margin-top: -10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <header><h2>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø´Ø®ØµÙŠØ© ğŸ“</h2></header>

    <div class="stats-grid">
        <div class="stat-card full-width">
            <span class="stat-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯ÙˆÙ„Ø§Ø±)</span>
            <span class="stat-val val-total" id="netUSD">0 $</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¨Ø¶ ($)</span>
            <span class="stat-val val-in" id="inUSD">0 $</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø±Ø¬ ($)</span>
            <span class="stat-val val-out" id="outUSD">0 $</span>
        </div>
        <div class="stat-card" style="border-top: 3px solid var(--orange);">
            <span class="stat-label">ØµØ§ÙÙŠ Ø§Ù„ØªØ±ÙƒÙŠ</span>
            <span class="stat-val" style="color:var(--orange)" id="netTRY">0 â‚º</span>
        </div>
        <div class="stat-card" style="border-top: 3px solid var(--red);">
            <span class="stat-label">Ø®Ø±Ø¬ Ø§Ù„ØªØ±ÙƒÙŠ</span>
            <span class="stat-val val-out" id="outTRY">0 â‚º</span>
        </div>
    </div>

    <div class="entry-card">
        <div class="row">
            <input type="date" id="date">
            <select id="currency">
                <option value="USD">Ø¯ÙˆÙ„Ø§Ø± $</option>
                <option value="TRY">ØªØ±ÙƒÙŠ â‚º</option>
            </select>
        </div>
        <div class="row">
            <select id="type">
                <option value="income">ğŸ“¥ Ù‚Ø¨Ø¶ (Ø¯Ø®Ù„)</option>
                <option value="expense">ğŸ“¤ ØµØ±Ù (Ø®Ø±Ø¬)</option>
            </select>
            <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="decimal">
        </div>
        <input type="text" id="desc" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ø§Ù„: Ù…Ø¨ÙŠØ¹ Ø¨Ø¶Ø§Ø¹Ø©)" style="width:100%; box-sizing:border-box; margin-bottom:15px;">
        <button id="addBtn" onclick="addNewEntry()">ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸</button>
    </div>

    <div class="list-header">
        <span>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±</span>
        <span id="itemsCount" style="color:var(--text-sub); font-size:0.8rem;">0 Ø¹Ù…Ù„ÙŠØ§Øª</span>
    </div>
    <div class="tx-list" id="mainList"></div>

    <div class="footer-actions">
        <button class="btn-footer btn-drive" onclick="startCloudSync()">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Drive</button>
        <div id="syncStatus" style="grid-column: span 2;">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
        <button class="btn-footer" onclick="saveToPhone()">ğŸ’¾ Ù†Ø³Ø®Ø© Ù„Ù„Ù‡Ø§ØªÙ</button>
        <button class="btn-footer" onclick="document.getElementById('importFile').click()">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
        <input type="file" id="importFile" style="display:none" onchange="loadFromPhone(this)">
        <button class="btn-footer" style="grid-column: span 2; color: var(--red); border-color: #fee2e2;" onclick="clearSystem()">ğŸ—‘ï¸ ØªØµÙÙŠØ± ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
</div>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
    const CLIENT_ID = '936346921354-koe7pedt9pdiocbrhbe0id9jjc89ctpo.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    
    let db = JSON.parse(localStorage.getItem('mahmoud_db_vFinal')) || [];
    let googleAccessToken = null;

    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.getElementById('date').valueAsDate = new Date();

    function updateView() {
        const list = document.getElementById('mainList');
        list.innerHTML = '';
        
        let s = { inD: 0, outD: 0, inT: 0, outT: 0 };

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        db.sort((a, b) => new Date(b.date) - new Date(a.date));

        db.forEach((item, index) => {
            let val = parseFloat(item.amount);
            
            // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
            if(item.currency === 'USD') {
                if(item.type === 'income') s.inD += val;
                else s.outD += val;
            } 
            // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ±ÙƒÙŠ
            else {
                if(item.type === 'income') s.inT += val;
                else s.outT += val;
            }

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const isInc = item.type === 'income';
            list.innerHTML += `
                <div class="tx-item">
                    <div class="tx-info">
                        <b>${item.desc}</b>
                        <small>${item.date} | ${item.currency === 'USD' ? 'Ø¯ÙˆÙ„Ø§Ø±' : 'ØªØ±ÙƒÙŠ'}</small>
                    </div>
                    <div class="tx-amount-box" style="display:flex; align-items:center;">
                        <span class="tx-amount ${isInc ? 'val-in' : 'val-out'}">
                            ${isInc ? '+' : '-'}${val.toLocaleString()} ${item.currency === 'USD' ? '$' : 'â‚º'}
                        </span>
                        <button class="del-btn" onclick="deleteEntry(${index})">Ã—</button>
                    </div>
                </div>`;
        });

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        document.getElementById('netUSD').innerText = (s.inD - s.outD).toLocaleString() + ' $';
        document.getElementById('inUSD').innerText = s.inD.toLocaleString() + ' $';
        document.getElementById('outUSD').innerText = s.outD.toLocaleString() + ' $';
        document.getElementById('netTRY').innerText = (s.inT - s.outT).toLocaleString() + ' â‚º';
        document.getElementById('outTRY').innerText = s.outT.toLocaleString() + ' â‚º';
        document.getElementById('itemsCount').innerText = db.length + ' Ø¹Ù…Ù„ÙŠØ§Øª';

        localStorage.setItem('mahmoud_db_vFinal', JSON.stringify(db));
    }

    function addNewEntry() {
        const amt = document.getElementById('amount').value;
        const desc = document.getElementById('desc').value;
        const date = document.getElementById('date').value;

        if(!amt || !desc || !date) {
            alert('Ø®ÙŠÙˆ Ù…Ø­Ù…ÙˆØ¯ØŒ ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ù‡ ÙŠØ±Ø¶Ù‰ Ø¹Ù„ÙŠÙƒ');
            return;
        }

        db.unshift({
            date: date,
            currency: document.getElementById('currency').value,
            type: document.getElementById('type').value,
            amount: amt,
            desc: desc
        });

        // ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª
        document.getElementById('amount').value = '';
        document.getElementById('desc').value = '';
        updateView();
    }

    function deleteEntry(i) {
        if(confirm('Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ù‡ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
            db.splice(i, 1);
            updateView();
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Google Drive ---
    function startCloudSync() {
        const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (res) => {
                if(res.access_token) {
                    googleAccessToken = res.access_token;
                    uploadToCloud();
                }
            }
        });
        client.requestAccessToken();
    }

    async function uploadToCloud() {
        document.getElementById('syncStatus').innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨...';
        const metadata = { name: 'Ù…Ø­Ø§Ø³Ø¨Ø©_Ù…Ø­Ù…ÙˆØ¯_Ù†Ø³Ø®Ø©_Ø³Ø­Ø§Ø¨ÙŠØ©.json', mimeType: 'application/json' };
        const fileData = new Blob([JSON.stringify(db)], { type: 'application/json' });
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', fileData);

        try {
            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + googleAccessToken },
                body: form
            });
            document.getElementById('syncStatus').innerText = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø±Ø§ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­';
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Google Drive Ø®ÙŠÙˆ!');
        } catch(e) {
            document.getElementById('syncStatus').innerText = 'âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
            alert('ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±ÙØ¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª');
        }
    }

    // --- Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ ---
    function saveToPhone() {
        const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Ø­Ø³Ø§Ø¨Ø§Øª_Ù…Ø­Ù…ÙˆØ¯_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function loadFromPhone(input) {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                db = JSON.parse(e.target.result);
                updateView();
                alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            } catch(e) { alert('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­!'); }
        };
        reader.readAsText(input.files[0]);
    }

    function clearSystem() {
        if(confirm('ØªÙ†Ø¨ÙŠÙ‡: Ø±Ø­ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù…ØªØ£ÙƒØ¯ØŸ')) {
            db = [];
            updateView();
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ„ Ù…Ø±Ø©
    updateView();
</script>

</body>
</html>
