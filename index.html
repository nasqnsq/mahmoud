<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯ PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --p: #4f46e5; --g: #10b981; --r: #ef4444; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1e293b; user-select: none; }
        .container { max-width: 480px; margin: 0 auto; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© */
        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { margin: 0; color: var(--p); font-weight: 800; }
        
        .main-stats { background: linear-gradient(135deg, var(--p), #6366f1); color: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2); text-align: center; margin-bottom: 15px; }
        .sub-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .val { display: block; font-weight: 800; font-size: 1.2rem; margin-top: 5px; }

        /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .form-card { background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eef2ff; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        input, select { flex: 1; padding: 14px; border: 1px solid #e2e8f0; border-radius: 15px; font-family: 'Cairo'; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--p); background: #fefeff; }
        .btn-add { width: 100%; background: var(--p); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 700; font-size: 1.1rem; cursor: pointer; }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        .list-container { background: var(--card); border-radius: 25px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; }
        .item-desc b { display: block; font-size: 1rem; margin-bottom: 2px; }
        .item-desc small { color: #94a3b8; font-size: 0.8rem; }
        .item-amt { text-align: left; font-weight: 800; }
        .del-btn { color: #cbd5e1; background: none; border: none; font-size: 1.3rem; margin-right: 15px; cursor: pointer; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø­Ø§Ø¨ */
        .cloud-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px; }
        .btn-cloud { padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-family: 'Cairo'; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .up { background: #4285F4; color: white; }
        .down { background: #34a853; color: white; }
        #status { text-align: center; font-size: 0.8rem; color: #64748b; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø´Ø®ØµÙŠØ© ğŸ“</h2></div>

    <div class="main-stats">
        <small>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù…ØªÙˆÙØ± (Ø¯ÙˆÙ„Ø§Ø±)</small>
        <span class="val" id="netUSD" style="font-size: 2.2rem;">0 $</span>
    </div>

    <div class="sub-stats">
        <div class="stat-box">
            <small style="color:var(--g)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¨Ø¶ ($)</small>
            <span class="val" id="totalIn" style="color:var(--g)">0 $</span>
        </div>
        <div class="stat-box">
            <small style="color:var(--r)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø±Ø¬ ($)</small>
            <span class="val" id="totalOut" style="color:var(--r)">0 $</span>
        </div>
    </div>

    <div class="form-card">
        <div class="input-row">
            <input type="date" id="date">
            <select id="currency">
                <option value="USD">Ø¯ÙˆÙ„Ø§Ø± $</option>
                <option value="TRY">ØªØ±ÙƒÙŠ â‚º</option>
            </select>
        </div>
        <div class="input-row">
            <select id="type">
                <option value="in">ğŸ“¥ Ø¯Ø®Ù„ (Ù‚Ø¨Ø¶)</option>
                <option value="out">ğŸ“¤ Ø®Ø±Ø¬ (ØµØ±Ù)</option>
            </select>
            <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="decimal">
        </div>
        <input type="text" id="desc" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø¯ÙØ¹Ø© Ø¨Ø¶Ø§Ø¹Ø©)" style="width:100%; box-sizing:border-box; margin-bottom:12px;">
        <button class="btn-add" onclick="addNew()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <div class="list-container" id="mainList"></div>

    <div class="cloud-actions">
        <button class="btn-cloud up" onclick="sync('upload')">â˜ï¸ Ø±ÙØ¹ Ù„Ù„Ø¯Ø±Ø§ÙŠÙ</button>
        <button class="btn-cloud down" onclick="sync('download')">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
    </div>
    <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
</div>

<script>
    const CLIENT_ID = '936346921354-koe7pedt9pdiocbrhbe0id9jjc89ctpo.apps.googleusercontent.com';
    const DB_NAME = 'mahmoud_v5_pro.json';
    let db = JSON.parse(localStorage.getItem('mahmoud_v5')) || [];
    
    document.getElementById('date').valueAsDate = new Date();

    function render() {
        const list = document.getElementById('mainList');
        list.innerHTML = '';
        let s = { inD: 0, outD: 0, netT: 0 };

        db.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item, i) => {
            let v = parseFloat(item.amt);
            if(item.cur === 'USD') {
                (item.type === 'in') ? s.inD += v : s.outD += v;
            } else {
                (item.type === 'in') ? s.netT += v : s.netT -= v;
            }

            list.innerHTML += `
                <div class="list-item">
                    <div class="item-desc">
                        <b>${item.desc}</b>
                        <small>${item.date} | ${item.cur === 'USD' ? 'Ø¯ÙˆÙ„Ø§Ø±' : 'ØªØ±ÙƒÙŠ'}</small>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="item-amt" style="color:${item.type==='in'?'var(--g)':'var(--r)'}">
                            ${item.type==='in'?'+':'-'}${v.toLocaleString()}${item.cur==='USD'?'$':'â‚º'}
                        </span>
                        <button class="del-btn" onclick="remove(${i})">Ã—</button>
                    </div>
                </div>`;
        });

        document.getElementById('netUSD').innerText = (s.inD - s.outD).toLocaleString() + ' $';
        document.getElementById('totalIn').innerText = s.inD.toLocaleString() + ' $';
        document.getElementById('totalOut').innerText = s.outD.toLocaleString() + ' $';
        localStorage.setItem('mahmoud_v5', JSON.stringify(db));
    }

    function addNew() {
        const amt = document.getElementById('amount').value;
        const desc = document.getElementById('desc').value;
        if(!amt || !desc) return alert('Ø¹Ø¨ÙŠ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø®ÙŠÙˆ!');
        
        db.unshift({
            date: document.getElementById('date').value,
            cur: document.getElementById('currency').value,
            type: document.getElementById('type').value,
            amt: amt,
            desc: desc
        });
        
        document.getElementById('amount').value = '';
        document.getElementById('desc').value = '';
        render();
    }

    function remove(i) { if(confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) { db.splice(i,1); render(); } }

    // Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±
    function sync(mode) {
        document.getElementById('status').innerText = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬ÙˆØ¬Ù„...';
        const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file',
            callback: async (res) => {
                if (!res.access_token) return;
                const token = res.access_token;

                try {
                    // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
                    const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DB_NAME}' and trashed=false`, {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(r => r.json());

                    const existingFile = search.files[0];

                    if (mode === 'upload') {
                        const metadata = { name: DB_NAME, mimeType: 'application/json' };
                        const fileBlob = new Blob([JSON.stringify(db)], { type: 'application/json' });
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', fileBlob);

                        let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
                        let method = 'POST';

                        if (existingFile) {
                            url = `https://www.googleapis.com/upload/drive/v3/files/${existingFile.id}?uploadType=multipart`;
                            method = 'PATCH';
                        }

                        await fetch(url, { method, headers: { Authorization: `Bearer ${token}` }, body: form });
                        document.getElementById('status').innerText = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹';
                        alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
                    } 
                    else if (mode === 'download') {
                        if (!existingFile) throw new Error('Ù…Ø§ ÙÙŠ Ù…Ù„ÙØ§Øª Ø³Ø§Ø¨Ù‚Ø©!');
                        const content = await fetch(`https://www.googleapis.com/drive/v3/files/${existingFile.id}?alt=media`, {
                            headers: { Authorization: `Bearer ${token}` }
                        }).then(r => r.json());
                        
                        if(confirm('Ù„Ù‚ÙŠØª Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§ØŸ')) {
                            db = content;
                            render();
                            document.getElementById('status').innerText = 'âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
                        }
                    }
                } catch (err) {
                    alert('Ø®Ø·Ø£: ' + err.message);
                    document.getElementById('status').innerText = 'âŒ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
                }
            }
        });
        client.requestAccessToken();
    }

    render();
</script>
</body>
</html>
